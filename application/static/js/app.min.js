/*!
 * Groceries v0.1.3
 * - - -
 * Copyright (c) 2014 T.Zengerink
 * Released under MIT lisenced
 * https://raw.github.com/Mytho/groceries/master/LISENCE.md
 */
(function(){var a,b,c,d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a=jQuery,b=document,c=window,c.APP={Model:{},View:{},Collection:{},timeoutId:null,focused:null,ajaxErrorHandler:function(a,b){return 401===b.status?c.location="login":void 0},init:function(){return a(b).ajaxError(APP.ajaxErrorHandler),APP.router=new APP.Router,Backbone.history.start({pushState:!0}),setTimeout(function(){return c.scrollTo(0,1)},100)}},APP.Router=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.routes={"":"home"},b.prototype.home=function(){return APP.groceryView=new APP.View.Grocery},b}(Backbone.Router),APP.Model.Item=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.initialize=function(){return this.set("bought",this.get("bought_by")||this.get("bought_date"))},b.prototype.toggle=function(){return this.save({bought:!this.get("bought")})},b}(Backbone.Model),APP.Model.Suggestion=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b}(Backbone.Model),APP.Collection.Grocery=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.model=APP.Model.Item,b.prototype.url="/items",b.prototype.comparator=function(a){return a.get("create_date")},b}(Backbone.Collection),APP.Collection.Suggestion=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b.prototype.filtered=[],b.prototype.model=APP.Model.Suggestion,b.prototype.url="/suggestions",b.prototype.comparator=function(a){return-a.get("count")},b.prototype.clear=function(){return this.filtered=[]},b.prototype.like=function(a){return this.filtered=this.filter(function(b){return-1!==b.get("name").toLowerCase().indexOf(a.toLowerCase())})},b}(Backbone.Collection),APP.View.Grocery=function(b){function d(){return d.__super__.constructor.apply(this,arguments)}return e(d,b),d.prototype.el=a("div#content"),d.prototype.groceries=a("ul#groceries"),d.prototype.input=a("input#new-item"),d.prototype.suggestions=a("ul#suggestions"),d.prototype.events={"click input#new-item":"onClick","focusout input#new-item":"onFocusOut","keyup input#new-item":"onKeyUp"},d.prototype.addAll=function(){return APP.groceries.each(this.addOne,this)},d.prototype.addOne=function(b){var c;return c=new APP.View.Item({model:b}),a(this.el).find("ul#groceries").append(c.render().el)},d.prototype.create=function(){return APP.groceries.create({name:this.input.val()}),this.input.val(""),this.groceries.show(),this.suggestions.hide()},d.prototype.initialize=function(){return APP.groceries=new APP.Collection.Grocery,APP.suggestions=new APP.Collection.Suggestion,this.listenTo(APP.groceries,"add",this.addOne),this.listenTo(APP.groceries,"reset",this.addAll),APP.groceries.fetch(),APP.suggestions.fetch()},d.prototype.onClick=function(){return APP.focused&&"new-item"===APP.focused.attr("id")?(APP.focused=null,this.input.blur()):(APP.focused=this.input,this.suggest())},d.prototype.onFocusOut=function(){var a;return a=this,APP.focused=null,APP.timeoutId=c.setTimeout(function(){return APP.focused=this.input,a.suggest()},250)},d.prototype.onKeyUp=function(a){return 13===a.keyCode&&""!==this.input.val()&&this.create(),13!==a.keyCode?this.suggest():void 0},d.prototype.suggest=function(){var b;return b=this,this.suggestions.html("").show(),this.input.is(":focus")&&APP.suggestions.like(this.input.val()),this.input.is(":focus")||APP.suggestions.clear(),_.each(APP.suggestions.filtered.slice(0,10),function(c){var d;return d=new APP.View.Suggestion({model:c}),a(b.suggestions).append(d.render().el)}),this.groceries.toggle(!this.input.is(":focus"))},d}(Backbone.View),APP.View.Item=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return e(c,b),c.prototype.tagName="li",c.prototype.events={click:"toggleDeleteButton","click label":"toggleBought","click .buy":"toggleBought","click .delete":"delete"},c.prototype["delete"]=function(){return this.model.destroy()},c.prototype.initialize=function(){return this.template=_.template(a("#item-template").html()),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},c.prototype.render=function(){return a(this.el).html(this.template(this.model.toJSON())),a(this.el).find(".delete").hide(),this},c.prototype.toggleDeleteButton=function(){return a(this.el).find(".delete").toggle()},c.prototype.toggleBought=function(b){return a(this.el).toggleClass("bought"),this.model.toggle(),b.stopPropagation()},c}(Backbone.View),APP.View.Suggestion=function(b){function d(){return d.__super__.constructor.apply(this,arguments)}return e(d,b),d.prototype.tagName="li",d.prototype.events={click:"addItem"},d.prototype.addItem=function(){return c.clearTimeout(APP.timeoutId),APP.groceries.create({name:this.model.get("name")}),a("ul#suggestions").hide(),a("ul#groceries").show(),a("input#new-item").val("")},d.prototype.initialize=function(){return this.template=_.template(a("#suggestion-template").html())},d.prototype.render=function(){return a(this.el).html(this.template(this.model.toJSON())),this},d}(Backbone.View)}).call(this);