/*!
 * Groceries v0.2.0
 * - - -
 * Copyright (c) 2014 Teun Zengerink
 * Released under MIT lisenced
 * https://raw.github.com/Mytho/groceries/master/LISENCE.md
 */
"use strict";var Groceries=angular.module("Groceries",["ngTouch","ngAnimate"]);Groceries.config(["$interpolateProvider",function(a){a.startSymbol("[[").endSymbol("]]")}]),Groceries.directive("swipeDelete",["$compile","$swipe","DeleteService","SwipeModel",function(a,b,c,d){return{restrict:"A",scope:{item:"=swipeDelete"},link:function(e,f){var g,h;h=new d(e,f),e.cancel=function(a,b){a.preventDefault(),a.stopPropagation(),c.cancel(b),h.cancel()},g=a('<span class="swipe-delete-overlay"><input type="checkbox"><label>[[item.name]]</label><button ng-click="cancel($event, item)">UNDO</button></span>')(e),f.addClass("swipe-delete").prepend(g),b.bind(f,h)}}}]),Groceries.factory("InputModel",["$timeout",function(a){var b={};return b.DELAY=250,b.isFocused=!1,b.value="",b.blur=function(b){this.isFocused&&a(function(){b.blur()},this.DELAY),this.isFocused=!1},b.focus=function(b){this.isFocused||a(function(){b.focus()},this.DELAY),this.isFocused=!0},b.onBlur=function(b){var c=this;b.preventDefault(),b.stopPropagation(),a(function(){c.blur(b.target)},this.DELAY)},b.onFocus=function(b){var c=this;b.preventDefault(),b.stopPropagation(),a(function(){c.focus(b.target)},c.DELAY)},b.onKeyup=function(b){var c=this;b.preventDefault(),b.stopPropagation(),13===b.keyCode&&this.value&&(this.onEnter(this.value),this.value="",a(function(){c.blur(b.target)},this.DELAY))},function(a){angular.extend(this,b,{onEnter:a})}}]),Groceries.factory("ItemModel",function(){return function(a){angular.extend(this,{id:null,name:"",created_by:null,created_date:null,bought_by:null,bought_date:null,isBought:function(){return!(!this.bought_by&&!this.bought_date)},update:function(a){angular.extend(this,a)}},a)}}),Groceries.factory("SwipeModel",["DeleteService",function(a){return function(b,c){var d={};d.CLASS_NAMES={active:"swipe-delete-active",scheduled:"swipe-delete-scheduled"},d.FULL_WIDTH_TRESHOLD=65,d.SWIPE_LEFT_TRESHOLD=10,d.isEnded=!1,d.startX=0,d.cancel=function(){this.element.removeClass(this.CLASS_NAMES.active),this.element.removeClass(this.CLASS_NAMES.scheduled),this.element.find("span").css("width",""),this.element.find("span").find("label").css("margin-left","")},d.end=function(){return this.isEnded=!0,a.isScheduled(this.scope.item)?(this.element.removeClass(this.CLASS_NAMES.active),this.element.addClass(this.CLASS_NAMES.scheduled),void this.element.find("span").find("label").css("margin-left","")):void this.cancel()},d.getClientWidth=function(){return this.element[0].clientWidth},d.getX=function(a){return a.x-this.element[0].offsetLeft},d.move=function(c){var d,e,f;if(e=this,f=this.getX(c),d=this.getClientWidth(),!this.isEnded){if(f<this.startX-this.SWIPE_LEFT_TRESHOLD)return void this.end();f>=d-this.FULL_WIDTH_TRESHOLD&&(f=d,b.$apply(function(){a.add(e.scope.item),e.end()})),this.element.addClass(this.CLASS_NAMES.active),this.element.find("span").css("width",f+"px"),this.element.find("span").find("label").css("margin-left",f+"px")}},d.start=function(a){this.isEnded=!1,this.startX=this.getX(a)},angular.extend(this,d,{scope:b,element:c})}}]),Groceries.service("DeleteService",["$timeout","GroceryService","HttpService","SuggestionService",function(a,b,c,d){this.DELAY=3e3,this.schedule={},this.add=function(b){var c=this;this.schedule[b.id]=a(function(){c.delete(b)},this.DELAY)},this.cancel=function(b){a.cancel(this.schedule[b.id]),delete this.schedule[b.id]},this.delete=function(a){var e=this;c.deleteItem(a.id).then(function(){b.remove(a),d.update(),delete e.schedule[a.id]})},this.isScheduled=function(a){return this.schedule.hasOwnProperty(a.id)}}]),Groceries.service("GroceryService",["HttpService",function(a){this.list=[],this.append=function(a){this.list.push(a)},this.remove=function(a){this.list.splice(this.list.indexOf(a),1)},this.update=function(){var b=this;a.getGroceries().then(function(a){b.list=a})},this.list.length||this.update()}]),Groceries.service("HttpService",["$http","$log","ItemModel",function(a,b,c){var d=function(a){var b,d;for(d=[],b=0;b<a.length;b++)d.push(new c(a[b]));return d};this.addItem=function(d){return a.post("/items",{name:d}).then(function(a){return new c(a.data)},function(){b.error("Could not add item")})},this.deleteItem=function(c){return a.delete("/items/"+c).then(function(a){return 200===a.status},function(){b.error("Could not delete item")})},this.toggleItem=function(d,e){return a.put("/items/"+d,{bought:e}).then(function(a){return new c(a.data)},function(){b.error("Could not toggle items")})},this.getGroceries=function(){return a.get("/items").then(function(a){return d(a.data)},function(){b.error("Could not load items")})},this.getSuggestions=function(){return a.get("/suggestions").then(function(a){return d(a.data)},function(){b.error("Could not load suggestions")})}}]),Groceries.service("SuggestionService",["HttpService",function(a){this.list=[],this.update=function(){var b=this;a.getSuggestions().then(function(a){b.list=a})},this.list.length||this.update()}]),Groceries.controller("ListController",["$document","$scope","$timeout","DeleteService","GroceryService","HttpService","InputModel","SuggestionService",function(a,b,c,d,e,f,g,h){b.GroceryService=e,b.SuggestionService=h,b.DeleteService=d,b.input=new g(function(a){b.add(a)}),b.add=function(a){f.addItem(a).then(function(a){e.append(a),h.update()})},b.buy=function(a,b){a.preventDefault(),a.stopPropagation(),d.isScheduled(b)||f.toggleItem(b.id,!b.isBought()).then(function(a){b.update(a)})},b.copy=function(c,d){c.preventDefault(),c.stopPropagation(),b.input.blur(a[0].getElementById("new-item")),b.input.value="",b.add(d.name)}}]);